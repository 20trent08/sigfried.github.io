<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[D3 visualizations, Underscore mixins, etc.]]></title>
  <link href="http://Sigfried.github.io/atom.xml" rel="self"/>
  <link href="http://Sigfried.github.io/"/>
  <updated>2015-03-16T12:44:36-04:00</updated>
  <id>http://Sigfried.github.io/</id>
  <author>
    <name><![CDATA[Sigfried Gold]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Supergroup]]></title>
    <link href="http://Sigfried.github.io/blog/supergroup/"/>
    <updated>2013-12-27T00:07:00-05:00</updated>
    <id>http://Sigfried.github.io/blog/supergroup</id>
    <content type="html"><![CDATA[<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.2/underscore.js"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.js"></script>


<script src="../../supergroup/supergroup.js"></script>


<script>
window.onload = function() {
var gradeBook = [
    {lastName: "Gold",    firstName: "Sigfried", class: "Remedial Programming",           grade: "C", num: 2},
    {lastName: "Gold",    firstName: "Sigfried", class: "Literary Posturing",             grade: "B", num: 3},
    {lastName: "Gold",    firstName: "Sigfried", class: "Documenting with Pretty Colors", grade: "B", num: 3},
    {lastName: "Sassoon", firstName: "Sigfried", class: "Remedial Programming",           grade: "A", num: 3},
    {lastName: "Androy",  firstName: "Sigfried", class: "Remedial Programming",           grade: "B", num: 3} 
];
var byLastName = _.supergroup(gradeBook, "lastName"); // an Array of Strings:  ["Gold","Sassoon","Androy"]
var byName = _.supergroup(gradeBook, function(d) { return d.firstName + ' ' + d.lastName; }); // an Array of Strings:  ["Sigfried Gold","Sigfried Sassoon","Sigfried Androy"]
var byClassGrade = _.supergroup(gradeBook, ["class", "grade"]); // Hierarchical grouping, top level is Array of classes
};
</script>


<p>Group CSV-type data into (hierarchically if desired) into arrays of String or Number objects
having immediate access to grouped records (at any level), aggregate calculations, children,
parents, paths.</p>

<!-- more -->


<p><a href="../../supergroup">Full API documentation</a></p>

<p>blah</p>

<figure class='code'><figcaption><span> (supergroup.js)</span> <a href='http://Sigfried.github.io/downloads/code/supergroup/supergroup.js'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
<span class='line-number'>457</span>
<span class='line-number'>458</span>
<span class='line-number'>459</span>
<span class='line-number'>460</span>
<span class='line-number'>461</span>
<span class='line-number'>462</span>
<span class='line-number'>463</span>
<span class='line-number'>464</span>
<span class='line-number'>465</span>
<span class='line-number'>466</span>
<span class='line-number'>467</span>
<span class='line-number'>468</span>
<span class='line-number'>469</span>
<span class='line-number'>470</span>
<span class='line-number'>471</span>
<span class='line-number'>472</span>
<span class='line-number'>473</span>
<span class='line-number'>474</span>
<span class='line-number'>475</span>
<span class='line-number'>476</span>
<span class='line-number'>477</span>
<span class='line-number'>478</span>
<span class='line-number'>479</span>
<span class='line-number'>480</span>
<span class='line-number'>481</span>
<span class='line-number'>482</span>
<span class='line-number'>483</span>
<span class='line-number'>484</span>
<span class='line-number'>485</span>
<span class='line-number'>486</span>
<span class='line-number'>487</span>
<span class='line-number'>488</span>
<span class='line-number'>489</span>
<span class='line-number'>490</span>
<span class='line-number'>491</span>
<span class='line-number'>492</span>
<span class='line-number'>493</span>
<span class='line-number'>494</span>
<span class='line-number'>495</span>
<span class='line-number'>496</span>
<span class='line-number'>497</span>
<span class='line-number'>498</span>
<span class='line-number'>499</span>
<span class='line-number'>500</span>
<span class='line-number'>501</span>
<span class='line-number'>502</span>
<span class='line-number'>503</span>
<span class='line-number'>504</span>
<span class='line-number'>505</span>
<span class='line-number'>506</span>
<span class='line-number'>507</span>
<span class='line-number'>508</span>
<span class='line-number'>509</span>
<span class='line-number'>510</span>
<span class='line-number'>511</span>
<span class='line-number'>512</span>
<span class='line-number'>513</span>
<span class='line-number'>514</span>
<span class='line-number'>515</span>
<span class='line-number'>516</span>
<span class='line-number'>517</span>
<span class='line-number'>518</span>
<span class='line-number'>519</span>
<span class='line-number'>520</span>
<span class='line-number'>521</span>
<span class='line-number'>522</span>
<span class='line-number'>523</span>
<span class='line-number'>524</span>
<span class='line-number'>525</span>
<span class='line-number'>526</span>
<span class='line-number'>527</span>
<span class='line-number'>528</span>
<span class='line-number'>529</span>
<span class='line-number'>530</span>
<span class='line-number'>531</span>
<span class='line-number'>532</span>
<span class='line-number'>533</span>
<span class='line-number'>534</span>
<span class='line-number'>535</span>
<span class='line-number'>536</span>
<span class='line-number'>537</span>
<span class='line-number'>538</span>
<span class='line-number'>539</span>
<span class='line-number'>540</span>
<span class='line-number'>541</span>
<span class='line-number'>542</span>
<span class='line-number'>543</span>
<span class='line-number'>544</span>
<span class='line-number'>545</span>
<span class='line-number'>546</span>
<span class='line-number'>547</span>
<span class='line-number'>548</span>
<span class='line-number'>549</span>
<span class='line-number'>550</span>
<span class='line-number'>551</span>
<span class='line-number'>552</span>
<span class='line-number'>553</span>
<span class='line-number'>554</span>
<span class='line-number'>555</span>
<span class='line-number'>556</span>
<span class='line-number'>557</span>
<span class='line-number'>558</span>
<span class='line-number'>559</span>
<span class='line-number'>560</span>
<span class='line-number'>561</span>
<span class='line-number'>562</span>
<span class='line-number'>563</span>
<span class='line-number'>564</span>
<span class='line-number'>565</span>
<span class='line-number'>566</span>
<span class='line-number'>567</span>
<span class='line-number'>568</span>
<span class='line-number'>569</span>
<span class='line-number'>570</span>
<span class='line-number'>571</span>
<span class='line-number'>572</span>
<span class='line-number'>573</span>
<span class='line-number'>574</span>
<span class='line-number'>575</span>
<span class='line-number'>576</span>
<span class='line-number'>577</span>
<span class='line-number'>578</span>
<span class='line-number'>579</span>
<span class='line-number'>580</span>
<span class='line-number'>581</span>
<span class='line-number'>582</span>
<span class='line-number'>583</span>
<span class='line-number'>584</span>
<span class='line-number'>585</span>
<span class='line-number'>586</span>
<span class='line-number'>587</span>
<span class='line-number'>588</span>
<span class='line-number'>589</span>
<span class='line-number'>590</span>
<span class='line-number'>591</span>
<span class='line-number'>592</span>
<span class='line-number'>593</span>
<span class='line-number'>594</span>
<span class='line-number'>595</span>
<span class='line-number'>596</span>
<span class='line-number'>597</span>
<span class='line-number'>598</span>
<span class='line-number'>599</span>
<span class='line-number'>600</span>
<span class='line-number'>601</span>
<span class='line-number'>602</span>
<span class='line-number'>603</span>
<span class='line-number'>604</span>
<span class='line-number'>605</span>
<span class='line-number'>606</span>
<span class='line-number'>607</span>
<span class='line-number'>608</span>
<span class='line-number'>609</span>
<span class='line-number'>610</span>
<span class='line-number'>611</span>
<span class='line-number'>612</span>
<span class='line-number'>613</span>
<span class='line-number'>614</span>
<span class='line-number'>615</span>
<span class='line-number'>616</span>
<span class='line-number'>617</span>
<span class='line-number'>618</span>
<span class='line-number'>619</span>
<span class='line-number'>620</span>
<span class='line-number'>621</span>
<span class='line-number'>622</span>
<span class='line-number'>623</span>
<span class='line-number'>624</span>
<span class='line-number'>625</span>
<span class='line-number'>626</span>
<span class='line-number'>627</span>
<span class='line-number'>628</span>
<span class='line-number'>629</span>
<span class='line-number'>630</span>
<span class='line-number'>631</span>
<span class='line-number'>632</span>
<span class='line-number'>633</span>
<span class='line-number'>634</span>
<span class='line-number'>635</span>
<span class='line-number'>636</span>
<span class='line-number'>637</span>
<span class='line-number'>638</span>
<span class='line-number'>639</span>
<span class='line-number'>640</span>
<span class='line-number'>641</span>
<span class='line-number'>642</span>
<span class='line-number'>643</span>
<span class='line-number'>644</span>
<span class='line-number'>645</span>
<span class='line-number'>646</span>
<span class='line-number'>647</span>
<span class='line-number'>648</span>
<span class='line-number'>649</span>
<span class='line-number'>650</span>
<span class='line-number'>651</span>
<span class='line-number'>652</span>
<span class='line-number'>653</span>
<span class='line-number'>654</span>
<span class='line-number'>655</span>
<span class='line-number'>656</span>
<span class='line-number'>657</span>
<span class='line-number'>658</span>
<span class='line-number'>659</span>
<span class='line-number'>660</span>
<span class='line-number'>661</span>
<span class='line-number'>662</span>
<span class='line-number'>663</span>
<span class='line-number'>664</span>
<span class='line-number'>665</span>
<span class='line-number'>666</span>
<span class='line-number'>667</span>
<span class='line-number'>668</span>
<span class='line-number'>669</span>
<span class='line-number'>670</span>
<span class='line-number'>671</span>
<span class='line-number'>672</span>
<span class='line-number'>673</span>
<span class='line-number'>674</span>
<span class='line-number'>675</span>
<span class='line-number'>676</span>
<span class='line-number'>677</span>
<span class='line-number'>678</span>
<span class='line-number'>679</span>
<span class='line-number'>680</span>
<span class='line-number'>681</span>
<span class='line-number'>682</span>
<span class='line-number'>683</span>
<span class='line-number'>684</span>
<span class='line-number'>685</span>
<span class='line-number'>686</span>
<span class='line-number'>687</span>
<span class='line-number'>688</span>
<span class='line-number'>689</span>
<span class='line-number'>690</span>
<span class='line-number'>691</span>
<span class='line-number'>692</span>
<span class='line-number'>693</span>
<span class='line-number'>694</span>
<span class='line-number'>695</span>
<span class='line-number'>696</span>
<span class='line-number'>697</span>
<span class='line-number'>698</span>
<span class='line-number'>699</span>
<span class='line-number'>700</span>
<span class='line-number'>701</span>
<span class='line-number'>702</span>
<span class='line-number'>703</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * # supergroup.js</span>
</span><span class='line'><span class="cm"> * Author: [Sigfried Gold](http://sigfried.org)  </span>
</span><span class='line'><span class="cm"> * License: [MIT](http://sigfried.mit-license.org/)  </span>
</span><span class='line'><span class="cm"> * Version: 0.0.2</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * usage examples at [http://sigfried.github.io/blog/supergroup](http://sigfried.github.io/blog/supergroup)</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="p">;</span> <span class="c1">// jshint -W053</span>
</span><span class='line'>
</span><span class='line'><span class="s1">&#39;use strict()&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">supergroup</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// @description local reference to supergroup namespace </span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">sg</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* @exported function supergroup.group(recs, dim, opts)</span>
</span><span class='line'><span class="cm">     * @param {Object[]} recs list of records to be grouped</span>
</span><span class='line'><span class="cm">     * @param {string or Function} dim either the property name to</span>
</span><span class='line'><span class="cm">        group by or a function returning a group by string or number</span>
</span><span class='line'><span class="cm">     * @param {Object} [opts]</span>
</span><span class='line'><span class="cm">     * @param {String} opts.childProp=&#39;children&#39; If group ends up being</span>
</span><span class='line'><span class="cm">        * hierarchical, this will be the property name of any children</span>
</span><span class='line'><span class="cm">     * @param {String[]} [opts.excludeValues] to exlude specific group values</span>
</span><span class='line'><span class="cm">     * @param {function} [opts.preListRecsHook] run recs through this</span>
</span><span class='line'><span class="cm">        * function before continuing processing</span>
</span><span class='line'><span class="cm">     * @param {function} [opts.dimName] defaults to the value of `dim`.</span>
</span><span class='line'><span class="cm">        * If `dim` is a function, the dimName will be ugly.</span>
</span><span class='line'><span class="cm">     * @return {Array of Values} enhanced with all the List methods</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * Avaailable as _.supergroup, Underscore mixin</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">sg</span><span class="p">.</span><span class="nx">group</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">recs</span><span class="p">,</span> <span class="nx">dim</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// if dim is an array, use multiDimList to create hierarchical grouping</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">dim</span><span class="p">).</span><span class="nx">isArray</span><span class="p">())</span> <span class="k">return</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">multiDimList</span><span class="p">(</span><span class="nx">recs</span><span class="p">,</span> <span class="nx">dim</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{};</span>
</span><span class='line'>        <span class="nx">recs</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">preListRecsHook</span> <span class="o">?</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">preListRecsHook</span><span class="p">(</span><span class="nx">recs</span><span class="p">)</span> <span class="o">:</span> <span class="nx">recs</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">childProp</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">childProp</span> <span class="o">||</span> <span class="nx">childProp</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// opts.multiValuedGroup is expected to be set automatically</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">groups</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">multiValuedGroup</span> <span class="o">?</span>
</span><span class='line'>            <span class="nx">multiValuedGroupBy</span><span class="p">(</span><span class="nx">recs</span><span class="p">,</span> <span class="nx">dim</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>            <span class="nx">_</span><span class="p">.</span><span class="nx">groupBy</span><span class="p">(</span><span class="nx">recs</span><span class="p">,</span> <span class="nx">dim</span><span class="p">);</span> <span class="c1">// use Underscore&#39;s groupBy: http://underscorejs.org/#groupBy</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">excludeValues</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">_</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">excludeValues</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">delete</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">d</span><span class="p">];</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">isNumeric</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="nx">opts</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;isNumeric&#39;</span><span class="p">)</span> <span class="o">?</span>
</span><span class='line'>                            <span class="nx">opts</span><span class="p">.</span><span class="nx">isNumeric</span> <span class="o">:</span>
</span><span class='line'>                            <span class="nx">wholeListNumeric</span><span class="p">(</span><span class="nx">groups</span><span class="p">);</span> <span class="c1">// does every group Value look like a number or a missing value?</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">groups</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pairs</span><span class="p">(</span><span class="nx">groups</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pair</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// setup Values for each group in List</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">rawVal</span> <span class="o">=</span> <span class="nx">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">val</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="nx">isNumeric</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">val</span> <span class="o">=</span> <span class="nx">makeNumberValue</span><span class="p">(</span><span class="nx">rawVal</span><span class="p">);</span> <span class="c1">// either everything&#39;s a Number</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">val</span> <span class="o">=</span> <span class="nx">makeStringValue</span><span class="p">(</span><span class="nx">rawVal</span><span class="p">);</span> <span class="c1">// or everything&#39;s a String</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="cm">/* The original records in this group are stored as an Array in </span>
</span><span class='line'><span class="cm">             * the records property (should probably be a getter method).</span>
</span><span class='line'><span class="cm">             */</span>
</span><span class='line'>            <span class="nx">val</span><span class="p">.</span><span class="nx">records</span> <span class="o">=</span> <span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>            <span class="cm">/* val.records is enhanced with Underscore methods for</span>
</span><span class='line'><span class="cm">             * convenience, but also with the supergroup method that&#39;s</span>
</span><span class='line'><span class="cm">             * been mixed in to Underscore. So you can group this specific</span>
</span><span class='line'><span class="cm">             * subset like: val.records.supergroup</span>
</span><span class='line'><span class="cm">             * on                                       FIX!!!!!!</span>
</span><span class='line'><span class="cm">             */</span>
</span><span class='line'>
</span><span class='line'>            <span class="nx">sg</span><span class="p">.</span><span class="nx">addSupergroupMethods</span><span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">records</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="nx">val</span><span class="p">.</span><span class="nx">dim</span> <span class="o">=</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">dimName</span><span class="p">)</span> <span class="o">?</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">dimName</span> <span class="o">:</span> <span class="nx">dim</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">val</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">parentVal</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span> <span class="c1">// NOT TESTED, NOT USED, PROBABLY WRONG</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span>
</span><span class='line'>                <span class="nx">val</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;depth&#39;</span> <span class="k">in</span> <span class="nx">val</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">val</span><span class="p">.</span><span class="nx">depth</span> <span class="o">=</span> <span class="nx">val</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">val</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">val</span><span class="p">.</span><span class="nx">depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">val</span><span class="p">.</span><span class="nx">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>        <span class="nx">groups</span> <span class="o">=</span> <span class="nx">makeList</span><span class="p">(</span><span class="nx">groups</span><span class="p">);</span> <span class="c1">// turns groups into a List object</span>
</span><span class='line'>        <span class="nx">groups</span><span class="p">.</span><span class="nx">records</span> <span class="o">=</span> <span class="nx">recs</span><span class="p">;</span> <span class="c1">// NOT TESTED, NOT USED, PROBABLY WRONG</span>
</span><span class='line'>        <span class="nx">groups</span><span class="p">.</span><span class="nx">dim</span> <span class="o">=</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">dimName</span><span class="p">)</span> <span class="o">?</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">dimName</span> <span class="o">:</span> <span class="nx">dim</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">groups</span><span class="p">.</span><span class="nx">isNumeric</span> <span class="o">=</span> <span class="nx">isNumeric</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">_</span><span class="p">(</span><span class="nx">groups</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">group</span><span class="p">.</span><span class="nx">parentList</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">;</span>
</span><span class='line'>            <span class="c1">//group.idxInParentList = i; // maybe a good idea, but don&#39;t need it yet</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>        <span class="c1">// pointless without recursion</span>
</span><span class='line'>        <span class="c1">//if (opts.postListListHook) groups = opts.postListListHook(groups);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">groups</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="c1">// nested groups, each dim is a level in hierarchy</span>
</span><span class='line'>    <span class="nx">sg</span><span class="p">.</span><span class="nx">multiDimList</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">recs</span><span class="p">,</span> <span class="nx">dims</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">groups</span> <span class="o">=</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">group</span><span class="p">(</span><span class="nx">recs</span><span class="p">,</span> <span class="nx">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">opts</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="nx">dims</span><span class="p">).</span><span class="nx">rest</span><span class="p">().</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">dim</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">groups</span><span class="p">.</span><span class="nx">addLevel</span><span class="p">(</span><span class="nx">dim</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">groups</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="c1">// @class List</span>
</span><span class='line'>    <span class="c1">// @description Native Array of groups with various added methods and properties.</span>
</span><span class='line'>    <span class="c1">// Methods described below.</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">List</span><span class="p">()</span> <span class="p">{}</span>
</span><span class='line'>    <span class="c1">// @class Value</span>
</span><span class='line'>    <span class="c1">// @description Supergroup Lists are composed of Values which are</span>
</span><span class='line'>    <span class="c1">// String or Number objects representing group values.</span>
</span><span class='line'>    <span class="c1">// Methods described below.</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">Value</span><span class="p">()</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// sometimes a root value is needed as the top of a hierarchy</span>
</span><span class='line'>    <span class="nx">List</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">asRootVal</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">dimName</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;Root&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">makeValue</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">val</span><span class="p">.</span><span class="nx">records</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="c1">// is this wrong?</span>
</span><span class='line'>        <span class="nx">val</span><span class="p">[</span><span class="nx">childProp</span><span class="p">]</span><span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">_</span><span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">descendants</span><span class="p">()).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="nx">d</span><span class="p">.</span><span class="nx">depth</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">val</span><span class="p">.</span><span class="nx">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">val</span><span class="p">.</span><span class="nx">dim</span> <span class="o">=</span> <span class="nx">dimName</span> <span class="o">||</span> <span class="s1">&#39;root&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">List</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">leafNodes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">invoke</span><span class="p">(</span><span class="s1">&#39;leafNodes&#39;</span><span class="p">).</span><span class="nx">flatten</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">addSupergroupMethods</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">value</span><span class="p">();</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">List</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rawValues</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">();</span> <span class="p">}).</span><span class="nx">value</span><span class="p">();</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="c1">// lookup a value in a list, or, if query is an array</span>
</span><span class='line'>    <span class="c1">//      it is interpreted as a path down the group hierarchy</span>
</span><span class='line'>    <span class="nx">List</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">lookup</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">query</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// if group has children, can search down the tree</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">ret</span><span class="p">;</span>
</span><span class='line'>            <span class="k">while</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">ret</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">singleLookup</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
</span><span class='line'>                <span class="nx">list</span> <span class="o">=</span> <span class="nx">ret</span><span class="p">[</span><span class="nx">childProp</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">singleLookup</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">List</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">singleLookup</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="s1">&#39;lookupMap&#39;</span> <span class="k">in</span> <span class="k">this</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">lookupMap</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">that</span><span class="p">.</span><span class="nx">lookupMap</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">query</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">lookupMap</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">lookupMap</span><span class="p">[</span><span class="nx">query</span><span class="p">];</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// lookup more than one thing at a time</span>
</span><span class='line'>    <span class="nx">List</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">lookupMany</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">addSupergroupMethods</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="nx">query</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">list</span><span class="p">.</span><span class="nx">singleLookup</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}).</span><span class="nx">compact</span><span class="p">().</span><span class="nx">value</span><span class="p">());</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">List</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">flattenTree</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="kd">var</span> <span class="nx">desc</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">descendants</span><span class="p">();</span>
</span><span class='line'>                        <span class="k">return</span> <span class="p">[</span><span class="nx">d</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">desc</span><span class="p">);</span>
</span><span class='line'>                    <span class="p">})</span>
</span><span class='line'>                    <span class="p">.</span><span class="nx">flatten</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">identity</span><span class="p">)</span> <span class="c1">// expunge nulls</span>
</span><span class='line'>                    <span class="p">.</span><span class="nx">tap</span><span class="p">(</span><span class="nx">sg</span><span class="p">.</span><span class="nx">addListMethods</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="nx">value</span><span class="p">();</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">List</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addLevel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dim</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">_</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">val</span><span class="p">.</span><span class="nx">addLevel</span><span class="p">(</span><span class="nx">dim</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="c1">// apply a function to the records of each group</span>
</span><span class='line'>    <span class="c1">// </span>
</span><span class='line'>    <span class="nx">List</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">groupRecordsApply</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">field</span><span class="p">,</span> <span class="nx">ret</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">field</span><span class="p">)</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>                           <span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
</span><span class='line'>                           <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">recs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                               <span class="k">return</span> <span class="nx">func</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="nx">recs</span><span class="p">,</span><span class="nx">field</span><span class="p">))</span>
</span><span class='line'>                           <span class="p">}).</span><span class="nx">value</span><span class="p">();</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">func</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="s1">&#39;records&#39;</span><span class="p">));</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">ret</span> <span class="o">===</span> <span class="s1">&#39;dict&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">object</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">results</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">List</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">entries</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">childProp</span> <span class="k">in</span> <span class="nx">val</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="p">{</span><span class="nx">key</span><span class="o">:</span> <span class="nx">val</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">values</span><span class="o">:</span> <span class="nx">val</span><span class="p">[</span><span class="nx">childProp</span><span class="p">].</span><span class="nx">entries</span><span class="p">()};</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">{</span><span class="nx">key</span><span class="o">:</span> <span class="nx">val</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">values</span><span class="o">:</span> <span class="nx">val</span><span class="p">.</span><span class="nx">records</span><span class="p">};</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/** Enhance arrays with {@link http://underscorejs.org/ Underscore} functions </span>
</span><span class='line'><span class="cm">     * that work on arrays. </span>
</span><span class='line'><span class="cm">     * @param {Array} arr</span>
</span><span class='line'><span class="cm">     * @return {Array} now enhanced</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * Now can call Underscore functions as methods on the array, and if</span>
</span><span class='line'><span class="cm">     * the return value is an array, it will also be enhanced.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @example</span>
</span><span class='line'><span class="cm">     * `enlightenedData.addUnderscoreMethods([&#39;a&#39;,&#39;bb&#39;,&#39;ccc&#39;])</span>
</span><span class='line'><span class="cm">     *      .pluck(&#39;length&#39;)</span>
</span><span class='line'><span class="cm">     *      .</span>
</span><span class='line'><span class="cm">     * group.where({foo:bar}).invoke(&#39;baz&#39;)</span>
</span><span class='line'><span class="cm">     * @returns {whatever the underscore function would return}</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @memberof enlightenedData </span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">    sg.addUnderscoreMethods = function(arr) {</span>
</span><span class='line'><span class="cm">        _(sg.underscoreMethodsToAddToArrays).each(function(methodName) {</span>
</span><span class='line'><span class="cm">            if (_(arr).has(methodName)) return;</span>
</span><span class='line'><span class="cm">            Object.defineProperty(arr, methodName, {</span>
</span><span class='line'><span class="cm">                value: function() {</span>
</span><span class='line'><span class="cm">                    var part = _.partial(_[methodName], arr);</span>
</span><span class='line'><span class="cm">                    var result = part.apply(null, _.toArray(arguments));</span>
</span><span class='line'><span class="cm">                    if (_.isArray(result)) sg.addListMethods(result);</span>
</span><span class='line'><span class="cm">                    return result;</span>
</span><span class='line'><span class="cm">                }});</span>
</span><span class='line'><span class="cm">        });</span>
</span><span class='line'><span class="cm">        return arr;</span>
</span><span class='line'><span class="cm">    };</span>
</span><span class='line'><span class="cm">    sg.underscoreMethodsToAddToArrays = [ </span>
</span><span class='line'><span class="cm">            &quot;each&quot;,</span>
</span><span class='line'><span class="cm">            &quot;map&quot;,</span>
</span><span class='line'><span class="cm">            &quot;reduce&quot;,</span>
</span><span class='line'><span class="cm">            &quot;find&quot;,</span>
</span><span class='line'><span class="cm">            &quot;filter&quot;,</span>
</span><span class='line'><span class="cm">            &quot;reject&quot;,</span>
</span><span class='line'><span class="cm">            &quot;all&quot;,</span>
</span><span class='line'><span class="cm">            &quot;every&quot;,</span>
</span><span class='line'><span class="cm">            &quot;any&quot;,</span>
</span><span class='line'><span class="cm">            &quot;some&quot;,</span>
</span><span class='line'><span class="cm">            &quot;contains&quot;,</span>
</span><span class='line'><span class="cm">            &quot;invoke&quot;,</span>
</span><span class='line'><span class="cm">            &quot;pluck&quot;,</span>
</span><span class='line'><span class="cm">            &quot;where&quot;,</span>
</span><span class='line'><span class="cm">            &quot;findWhere&quot;,</span>
</span><span class='line'><span class="cm">            &quot;max&quot;,</span>
</span><span class='line'><span class="cm">            &quot;min&quot;,</span>
</span><span class='line'><span class="cm">            &quot;shuffle&quot;,</span>
</span><span class='line'><span class="cm">            &quot;sortBy&quot;,</span>
</span><span class='line'><span class="cm">            &quot;groupBy&quot;,</span>
</span><span class='line'><span class="cm">            &quot;countBy&quot;,</span>
</span><span class='line'><span class="cm">            &quot;sortedIndex&quot;,</span>
</span><span class='line'><span class="cm">            &quot;size&quot;,</span>
</span><span class='line'><span class="cm">            &quot;first&quot;,</span>
</span><span class='line'><span class="cm">            &quot;initial&quot;,</span>
</span><span class='line'><span class="cm">            &quot;last&quot;,</span>
</span><span class='line'><span class="cm">            &quot;rest&quot;,</span>
</span><span class='line'><span class="cm">            &quot;compact&quot;,</span>
</span><span class='line'><span class="cm">            &quot;flatten&quot;,</span>
</span><span class='line'><span class="cm">            &quot;without&quot;,</span>
</span><span class='line'><span class="cm">            &quot;uniq&quot;,</span>
</span><span class='line'><span class="cm">            &quot;union&quot;,</span>
</span><span class='line'><span class="cm">            &quot;intersection&quot;,</span>
</span><span class='line'><span class="cm">            &quot;difference&quot;,</span>
</span><span class='line'><span class="cm">            &quot;zip&quot;,</span>
</span><span class='line'><span class="cm">            &quot;unzip&quot;,</span>
</span><span class='line'><span class="cm">            //&quot;object&quot;,</span>
</span><span class='line'><span class="cm">            &quot;indexOf&quot;,</span>
</span><span class='line'><span class="cm">            &quot;lastIndexOf&quot;,</span>
</span><span class='line'><span class="cm">            &quot;chain&quot;,</span>
</span><span class='line'><span class="cm">            &quot;result&quot;</span>
</span><span class='line'><span class="cm">            ];</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">makeValue</span><span class="p">(</span><span class="nx">v_arg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">v_arg</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">makeStringValue</span><span class="p">(</span><span class="nx">v_arg</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">makeNumberValue</span><span class="p">(</span><span class="nx">v_arg</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">StringValue</span><span class="p">()</span> <span class="p">{}</span>
</span><span class='line'>    <span class="c1">//StringValue.prototype = new String;</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">makeStringValue</span><span class="p">(</span><span class="nx">s_arg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">S</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">String</span><span class="p">(</span><span class="nx">s_arg</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">//S.__proto__ = StringValue.prototype; // won&#39;t work in IE10</span>
</span><span class='line'>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">method</span> <span class="k">in</span> <span class="nx">StringValue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">S</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">value</span><span class="o">:</span> <span class="nx">StringValue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">S</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">NumberValue</span><span class="p">()</span> <span class="p">{}</span>
</span><span class='line'>    <span class="c1">//NumberValue.prototype = new Number;</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">makeNumberValue</span><span class="p">(</span><span class="nx">n_arg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">N</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">n_arg</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">//N.__proto__ = NumberValue.prototype;</span>
</span><span class='line'>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">method</span> <span class="k">in</span> <span class="nx">NumberValue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">N</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">value</span><span class="o">:</span> <span class="nx">NumberValue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">N</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">wholeListNumeric</span><span class="p">(</span><span class="nx">groups</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">isNumeric</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">groups</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span>      <span class="nx">k</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span>
</span><span class='line'>                        <span class="nx">k</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span>
</span><span class='line'>                        <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">k</span><span class="p">)))</span> <span class="o">||</span>
</span><span class='line'>                        <span class="p">[</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;undefined&quot;</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">k</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">())</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">isNumeric</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">groups</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">k</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">delete</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">k</span><span class="p">];</span>        <span class="c1">// getting rid of NULL values in dim list!!</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">isNumeric</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">childProp</span> <span class="o">=</span> <span class="s1">&#39;children&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">Value</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">extendGroupBy</span> <span class="o">=</span> <span class="c1">// backward compatibility</span>
</span><span class='line'>    <span class="nx">Value</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addLevel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dim</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{};</span>
</span><span class='line'>        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">leafNodes</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">opts</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="k">in</span> <span class="o">&amp;&amp;</span> <span class="nx">d</span><span class="p">.</span><span class="k">in</span> <span class="o">===</span> <span class="s2">&quot;both&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">d</span><span class="p">[</span><span class="nx">childProp</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">diffList</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">dim</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">d</span><span class="p">[</span><span class="nx">childProp</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">group</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">records</span><span class="p">,</span> <span class="nx">dim</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="k">in</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">_</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="nx">childProp</span><span class="p">]).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nx">c</span><span class="p">.</span><span class="k">in</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="k">in</span><span class="p">;</span>
</span><span class='line'>                        <span class="nx">c</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="k">in</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="k">in</span><span class="p">];</span>
</span><span class='line'>                    <span class="p">});</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="nx">d</span><span class="p">[</span><span class="nx">childProp</span><span class="p">].</span><span class="nx">parentVal</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span> <span class="c1">// NOT TESTED, NOT USED, PROBABLY WRONG!!!</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">Value</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">leafNodes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">];</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">level</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">level</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">[</span><span class="nx">childProp</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">[</span><span class="nx">childProp</span><span class="p">].</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">level</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">depth</span> <span class="o">&lt;</span> <span class="nx">level</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">ret</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">childProp</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">leafNodes</span><span class="p">(</span><span class="nx">level</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}),</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">makeList</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="cm">/*  didn&#39;t make this yet, just copied from above</span>
</span><span class='line'><span class="cm">    Value.prototype.descendants = function(level) {</span>
</span><span class='line'><span class="cm">        var ret = [this];</span>
</span><span class='line'><span class="cm">        if (level !== 0 &amp;&amp; this[childProp] &amp;&amp; (!level || this.depth &lt; level))</span>
</span><span class='line'><span class="cm">            ret = _.flatten(_.map(this[childProp], function(c) {</span>
</span><span class='line'><span class="cm">                return c.leafNodes(level);</span>
</span><span class='line'><span class="cm">            }), true);</span>
</span><span class='line'><span class="cm">        return makeList(ret);</span>
</span><span class='line'><span class="cm">    };</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">delimOpts</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">opts</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span><span class="nx">delim</span><span class="o">:</span> <span class="nx">opts</span><span class="p">};</span>
</span><span class='line'>        <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{};</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">(</span><span class="nx">opts</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;delim&#39;</span><span class="p">))</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">delim</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">opts</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">Value</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dimPath</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">opts</span> <span class="o">=</span> <span class="nx">delimOpts</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">opts</span><span class="p">.</span><span class="nx">dimName</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">namePath</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">Value</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">namePath</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">opts</span> <span class="o">=</span> <span class="nx">delimOpts</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pedigree</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">noRoot</span><span class="p">)</span> <span class="nx">path</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">backwards</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">backwards</span><span class="p">)</span> <span class="nx">path</span><span class="p">.</span><span class="nx">reverse</span><span class="p">();</span> <span class="c1">//kludgy?</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">dimName</span><span class="p">)</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="nx">path</span><span class="p">).</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">&#39;dim&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">asArray</span><span class="p">)</span> <span class="k">return</span> <span class="nx">path</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">delim</span><span class="p">);</span>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">        var delim = opts.delim || &#39;/&#39;;</span>
</span><span class='line'><span class="cm">        return (this.parent ? </span>
</span><span class='line'><span class="cm">                this.parent.namePath(_.extend({},opts,{notLeaf:true})) : &#39;&#39;) +</span>
</span><span class='line'><span class="cm">            ((opts.noRoot &amp;&amp; this.depth===0) ? &#39;&#39; : </span>
</span><span class='line'><span class="cm">                (this + (opts.notLeaf ? delim : &#39;&#39;))</span>
</span><span class='line'><span class="cm">             )</span>
</span><span class='line'><span class="cm">        */</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">Value</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pedigree</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">opts</span> <span class="o">&amp;&amp;</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">notThis</span><span class="p">))</span> <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">ptr</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">((</span><span class="nx">ptr</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">.</span><span class="nx">parent</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">path</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">ptr</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">path</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// CHANGING -- HOPE THIS DOESN&#39;T BREAK STUFF (pedigree isn&#39;t</span>
</span><span class='line'>        <span class="c1">// documented yet)</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">opts</span> <span class="o">&amp;&amp;</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">asValues</span><span class="p">))</span> <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="nx">path</span><span class="p">).</span><span class="nx">invoke</span><span class="p">(</span><span class="s1">&#39;valueOf&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">();</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">path</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">Value</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">descendants</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">[</span><span class="nx">childProp</span><span class="p">]</span> <span class="o">?</span> <span class="k">this</span><span class="p">[</span><span class="nx">childProp</span><span class="p">].</span><span class="nx">flattenTree</span><span class="p">()</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">Value</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">lookup</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">query</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">()</span> <span class="o">==</span> <span class="nx">query</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span> <span class="c1">// allow string/num comparison to succeed?</span>
</span><span class='line'>                <span class="nx">query</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">query</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">()</span> <span class="o">==</span> <span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;invalid param: &quot;</span> <span class="o">+</span> <span class="nx">query</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">[</span><span class="nx">childProp</span><span class="p">])</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;can only call lookup on Values with kids&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">[</span><span class="nx">childProp</span><span class="p">].</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">Value</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pct</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentList</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/** Summarize records by a dimension</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @param {list} Records to be summarized</span>
</span><span class='line'><span class="cm">     * @param {numericDim} Dimension to summarize by</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @memberof supergroup</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">sg</span><span class="p">.</span><span class="nx">aggregate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">numericDim</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">numericDim</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">list</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="nx">list</span><span class="p">).</span><span class="nx">pluck</span><span class="p">(</span><span class="nx">numericDim</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">_</span><span class="p">(</span><span class="nx">list</span><span class="p">).</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">memo</span><span class="p">,</span><span class="nx">num</span><span class="p">){</span>
</span><span class='line'>                    <span class="nx">memo</span><span class="p">.</span><span class="nx">sum</span><span class="o">+=</span><span class="nx">num</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">memo</span><span class="p">.</span><span class="nx">cnt</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">memo</span><span class="p">.</span><span class="nx">avg</span><span class="o">=</span><span class="nx">memo</span><span class="p">.</span><span class="nx">sum</span><span class="o">/</span><span class="nx">memo</span><span class="p">.</span><span class="nx">cnt</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">memo</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">memo</span><span class="p">.</span><span class="nx">max</span><span class="p">,</span> <span class="nx">num</span><span class="p">);</span>
</span><span class='line'>                    <span class="k">return</span> <span class="nx">memo</span><span class="p">;</span>
</span><span class='line'>                <span class="p">},{</span><span class="nx">sum</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="nx">cnt</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="nx">max</span><span class="o">:-</span><span class="kc">Infinity</span><span class="p">});</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="cm">/** Compare groups across two similar root notes</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @param {from} ...</span>
</span><span class='line'><span class="cm">     * @param {to} ...</span>
</span><span class='line'><span class="cm">     * @param {dim} ...</span>
</span><span class='line'><span class="cm">     * @param {opts} ...</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * used by treelike and some earlier code</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @memberof supergroup</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">sg</span><span class="p">.</span><span class="nx">diffList</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">dim</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">fromList</span> <span class="o">=</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">group</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">records</span><span class="p">,</span> <span class="nx">dim</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">toList</span> <span class="o">=</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">group</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">records</span><span class="p">,</span> <span class="nx">dim</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">makeList</span><span class="p">(</span><span class="nx">sg</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">fromList</span><span class="p">,</span> <span class="nx">toList</span><span class="p">,</span> <span class="nx">dim</span><span class="p">));</span>
</span><span class='line'>        <span class="nx">list</span><span class="p">.</span><span class="nx">dim</span> <span class="o">=</span> <span class="p">(</span><span class="nx">opts</span> <span class="o">&amp;&amp;</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">dimName</span><span class="p">)</span> <span class="o">?</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">dimName</span> <span class="o">:</span> <span class="nx">dim</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">list</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/** Compare two groups by a dimension</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @param {A} ...</span>
</span><span class='line'><span class="cm">     * @param {B} ...</span>
</span><span class='line'><span class="cm">     * @param {dim} ...</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @memberof supergroup</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">sg</span><span class="p">.</span><span class="nx">compare</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">A</span><span class="p">,</span> <span class="nx">B</span><span class="p">,</span> <span class="nx">dim</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="nx">A</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="p">}).</span><span class="nx">value</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="nx">B</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="p">}).</span><span class="nx">value</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">comp</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>        <span class="nx">_</span><span class="p">(</span><span class="nx">A</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">comp</span><span class="p">[</span><span class="nx">d</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">name</span><span class="o">:</span> <span class="nx">d</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="k">in</span><span class="o">:</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="nx">from</span><span class="o">:</span> <span class="nx">d</span><span class="p">,</span>
</span><span class='line'>                <span class="nx">fromIdx</span><span class="o">:</span> <span class="nx">i</span><span class="p">,</span>
</span><span class='line'>                <span class="nx">dim</span><span class="o">:</span> <span class="nx">dim</span>
</span><span class='line'>            <span class="p">};</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>        <span class="nx">_</span><span class="p">(</span><span class="nx">B</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">((</span><span class="nx">d</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">in</span> <span class="nx">comp</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">comp</span><span class="p">[</span><span class="nx">d</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="p">];</span>
</span><span class='line'>                <span class="nx">c</span><span class="p">.</span><span class="k">in</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">c</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">c</span><span class="p">.</span><span class="nx">toIdx</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">comp</span><span class="p">[</span><span class="nx">d</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">name</span><span class="o">:</span> <span class="nx">d</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>                    <span class="k">in</span><span class="o">:</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">to</span><span class="o">:</span> <span class="nx">d</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">toIdx</span><span class="o">:</span> <span class="nx">i</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">dim</span><span class="o">:</span> <span class="nx">dim</span>
</span><span class='line'>                <span class="p">};</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="nx">comp</span><span class="p">).</span><span class="nx">values</span><span class="p">().</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">fromIdx</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">fromIdx</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">toIdx</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">toIdx</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">makeValue</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">d</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">val</span><span class="p">.</span><span class="nx">records</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;from&#39;</span> <span class="k">in</span> <span class="nx">d</span><span class="p">)</span>
</span><span class='line'>                <span class="nx">val</span><span class="p">.</span><span class="nx">records</span> <span class="o">=</span> <span class="nx">val</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">records</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;to&#39;</span> <span class="k">in</span> <span class="nx">d</span><span class="p">)</span>
</span><span class='line'>                <span class="nx">val</span><span class="p">.</span><span class="nx">records</span> <span class="o">=</span> <span class="nx">val</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">records</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">}).</span><span class="nx">value</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="nx">list</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">d</span><span class="p">.</span><span class="nx">parentList</span> <span class="o">=</span> <span class="nx">list</span><span class="p">;</span> <span class="c1">// NOT TESTED, NOT USED, PROBABLY WRONG</span>
</span><span class='line'>            <span class="nx">d</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">parentVal</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span> <span class="c1">// NOT TESTED, NOT USED, PROBABLY WRONG</span>
</span><span class='line'>        <span class="p">}).</span><span class="nx">value</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nx">list</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/** Concatenate two Values into a new one (??)</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @param {from} ...</span>
</span><span class='line'><span class="cm">     * @param {to} ...</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @memberof supergroup</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">sg</span><span class="p">.</span><span class="nx">compareValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">dim</span> <span class="o">!==</span> <span class="nx">to</span><span class="p">.</span><span class="nx">dim</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;not sure what you&#39;re trying to do&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">from</span> <span class="o">+</span> <span class="s1">&#39; to &#39;</span> <span class="o">+</span> <span class="nx">to</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">makeValue</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">val</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">val</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">val</span><span class="p">.</span><span class="nx">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">val</span><span class="p">.</span><span class="k">in</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">val</span><span class="p">.</span><span class="nx">records</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">records</span><span class="p">,</span><span class="nx">to</span><span class="p">.</span><span class="nx">records</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">val</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">parentVal</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span> <span class="c1">// NOT TESTED, NOT USED, PROBABLY WRONG</span>
</span><span class='line'>        <span class="nx">val</span><span class="p">.</span><span class="nx">dim</span> <span class="o">=</span> <span class="nx">from</span><span class="p">.</span><span class="nx">dim</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">StringValue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Value</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">NumberValue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Value</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/** Sometimes a List gets turned into a standard array,</span>
</span><span class='line'><span class="cm">     *  sg.g., through slicing or sorting or filtering. </span>
</span><span class='line'><span class="cm">     *  addListMethods turns it back into a List</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * `List` would be a constructor if IE10 supported</span>
</span><span class='line'><span class="cm">     * \_\_proto\_\_, so it pretends to be one instead.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @param {Array} Array to be extended</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @memberof supergroup</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">sg</span><span class="p">.</span><span class="nx">addSupergroupMethods</span> <span class="o">=</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">sg</span><span class="p">.</span><span class="nx">addListMethods</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">method</span> <span class="k">in</span> <span class="nx">List</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">value</span><span class="o">:</span> <span class="nx">List</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// can&#39;t easily subclass Array, so this explicitly puts the List</span>
</span><span class='line'>    <span class="c1">// methods on an Array that&#39;s supposed to be a List</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">makeList</span><span class="p">(</span><span class="nx">arr_arg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="p">[</span> <span class="p">];</span>
</span><span class='line'>        <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">arr_arg</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">sg</span><span class="p">.</span><span class="nx">addListMethods</span><span class="p">(</span><span class="nx">arr</span><span class="p">);</span>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">        //arr.__proto__ = List.prototype;</span>
</span><span class='line'><span class="cm">        for(var method in List.prototype) {</span>
</span><span class='line'><span class="cm">            Object.defineProperty(arr, method, {</span>
</span><span class='line'><span class="cm">                value: List.prototype[method]</span>
</span><span class='line'><span class="cm">            });</span>
</span><span class='line'><span class="cm">        }</span>
</span><span class='line'><span class="cm">        */</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">sg</span><span class="p">;</span>
</span><span class='line'><span class="p">}());</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// lodash createAggregator function, which lodash makes private</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Creates a function that aggregates a collection, creating an object or</span>
</span><span class='line'><span class="cm">     * array composed from the results of running each element of the collection</span>
</span><span class='line'><span class="cm">     * through a callback. The given setter function sets the keys and values</span>
</span><span class='line'><span class="cm">     * of the composed object or array.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @private</span>
</span><span class='line'><span class="cm">     * @param {Function} setter The setter function.</span>
</span><span class='line'><span class="cm">     * @param {boolean} [retArray=false] A flag to indicate that the aggregator</span>
</span><span class='line'><span class="cm">     *  function should return an array.</span>
</span><span class='line'><span class="cm">     * @returns {Function} Returns the new aggregator function.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">createAggregator</span><span class="p">(</span><span class="nx">setter</span><span class="p">,</span> <span class="nx">retArray</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">thisArg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">retArray</span> <span class="o">?</span> <span class="p">[[],</span> <span class="p">[]]</span> <span class="o">:</span> <span class="p">{};</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">callback</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">createCallback</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">thisArg</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">collection</span><span class="p">))</span> <span class="p">{</span>    <span class="c1">// using _.isArray instead of private isArray</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span class='line'>              <span class="nx">length</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
</span><span class='line'>            <span class="nx">setter</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">collection</span><span class="p">),</span> <span class="nx">collection</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">baseEach</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">setter</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">collection</span><span class="p">),</span> <span class="nx">collection</span><span class="p">);</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Creates an object composed of keys generated from the results of running</span>
</span><span class='line'><span class="cm">     * each element of a collection through the callback. The corresponding value</span>
</span><span class='line'><span class="cm">     * of each key is an array of the elements responsible for generating the key.</span>
</span><span class='line'><span class="cm">     * The callback is bound to `thisArg` and invoked with three arguments;</span>
</span><span class='line'><span class="cm">     * (value, index|key, collection).</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * If a property name is provided for `callback` the created &quot;_.pluck&quot; style</span>
</span><span class='line'><span class="cm">     * callback will return the property value of the given element.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * If an object is provided for `callback` the created &quot;_.where&quot; style callback</span>
</span><span class='line'><span class="cm">     * will return `true` for elements that have the properties of the given object,</span>
</span><span class='line'><span class="cm">     * else `false`.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @static</span>
</span><span class='line'><span class="cm">     * @memberOf _</span>
</span><span class='line'><span class="cm">     * @category Collections</span>
</span><span class='line'><span class="cm">     * @param {Array|Object|string} collection The collection to iterate over.</span>
</span><span class='line'><span class="cm">     * @param {Function|Object|string} [callback=identity] The function called</span>
</span><span class='line'><span class="cm">     *  per iteration. If a property name or object is provided it will be used</span>
</span><span class='line'><span class="cm">     *  to create a &quot;_.pluck&quot; or &quot;_.where&quot; style callback, respectively.</span>
</span><span class='line'><span class="cm">     * @param {*} [thisArg] The `this` binding of `callback`.</span>
</span><span class='line'><span class="cm">     * @returns {Object} Returns the composed aggregate object.</span>
</span><span class='line'><span class="cm">     * @example</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * _.groupBy([4.2, 6.1, 6.4], function(num) { return Math.floor(num); });</span>
</span><span class='line'><span class="cm">     * // =&gt; { &#39;4&#39;: [4.2], &#39;6&#39;: [6.1, 6.4] }</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * _.groupBy([4.2, 6.1, 6.4], function(num) { return this.floor(num); }, Math);</span>
</span><span class='line'><span class="cm">     * // =&gt; { &#39;4&#39;: [4.2], &#39;6&#39;: [6.1, 6.4] }</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * // using &quot;_.pluck&quot; callback shorthand</span>
</span><span class='line'><span class="cm">     * _.groupBy([&#39;one&#39;, &#39;two&#39;, &#39;three&#39;], &#39;length&#39;);</span>
</span><span class='line'><span class="cm">     * // =&gt; { &#39;3&#39;: [&#39;one&#39;, &#39;two&#39;], &#39;5&#39;: [&#39;three&#39;] }</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">groupBy</span> <span class="o">=</span> <span class="nx">createAggregator</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">value</span><span class="p">];</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// allows grouping by a field that contains an array of strings rather than just a string</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">multiValuedGroupBy</span> <span class="o">=</span> <span class="nx">createAggregator</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">keys</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">value</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">_</span><span class="p">.</span><span class="nx">mixin</span><span class="p">({</span><span class="nx">supergroup</span><span class="o">:</span> <span class="nx">supergroup</span><span class="p">.</span><span class="nx">group</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">addSupergroupMethods</span><span class="o">:</span> <span class="nx">supergroup</span><span class="p">.</span><span class="nx">addSupergroupMethods</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">multiValuedGroupBy</span><span class="o">:</span> <span class="nx">multiValuedGroupBy</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>(getting rid of underscore-unchained, which was a bad idea altogether)</p>

<figure class='code'><figcaption><span>Some records loaded from a CSV or JSON file</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">var</span> <span class="err">gradeBook</span> <span class="err">=</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span><span class="err">lastName:</span> <span class="nt">&quot;Gold&quot;</span><span class="p">,</span>    <span class="err">firstName:</span> <span class="nt">&quot;Sigfried&quot;</span><span class="p">,</span> <span class="err">class:</span> <span class="nt">&quot;Remedial Programming&quot;</span><span class="p">,</span>           <span class="err">grade:</span> <span class="nt">&quot;C&quot;</span><span class="p">,</span> <span class="err">num:</span> <span class="err">2</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="err">lastName:</span> <span class="nt">&quot;Gold&quot;</span><span class="p">,</span>    <span class="err">firstName:</span> <span class="nt">&quot;Sigfried&quot;</span><span class="p">,</span> <span class="err">class:</span> <span class="nt">&quot;Literary Posturing&quot;</span><span class="p">,</span>             <span class="err">grade:</span> <span class="nt">&quot;B&quot;</span><span class="p">,</span> <span class="err">num:</span> <span class="err">3</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="err">lastName:</span> <span class="nt">&quot;Gold&quot;</span><span class="p">,</span>    <span class="err">firstName:</span> <span class="nt">&quot;Sigfried&quot;</span><span class="p">,</span> <span class="err">class:</span> <span class="nt">&quot;Documenting with Pretty Colors&quot;</span><span class="p">,</span> <span class="err">grade:</span> <span class="nt">&quot;B&quot;</span><span class="p">,</span> <span class="err">num:</span> <span class="err">3</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="err">lastName:</span> <span class="nt">&quot;Sassoon&quot;</span><span class="p">,</span> <span class="err">firstName:</span> <span class="nt">&quot;Sigfried&quot;</span><span class="p">,</span> <span class="err">class:</span> <span class="nt">&quot;Remedial Programming&quot;</span><span class="p">,</span>           <span class="err">grade:</span> <span class="nt">&quot;A&quot;</span><span class="p">,</span> <span class="err">num:</span> <span class="err">3</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="err">lastName:</span> <span class="nt">&quot;Androy&quot;</span><span class="p">,</span>  <span class="err">firstName:</span> <span class="nt">&quot;Sigfried&quot;</span><span class="p">,</span> <span class="err">class:</span> <span class="nt">&quot;Remedial Programming&quot;</span><span class="p">,</span>           <span class="err">grade:</span> <span class="nt">&quot;B&quot;</span><span class="p">,</span> <span class="err">num:</span> <span class="err">3</span><span class="p">}</span>
</span><span class='line'><span class="p">]</span><span class="err">;</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>Grouping on one dimension</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">byLastName</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">supergroup</span><span class="p">(</span><span class="nx">gradeBook</span><span class="p">,</span> <span class="s2">&quot;lastName&quot;</span><span class="p">);</span> <span class="c1">// an Array of Strings:  [&quot;Gold&quot;,&quot;Sassoon&quot;,&quot;Androy&quot;]</span>
</span><span class='line'><span class="nx">byLastName</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">records</span><span class="p">;</span> <span class="c1">// Array of Sigfried Gold&#39;s original 3 records</span>
</span><span class='line'><span class="nx">byLastName</span><span class="p">.</span><span class="nx">rawValues</span><span class="p">();</span> <span class="c1">// Array of native strings (easier to look at or use in contexts where you need a plain string)</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>Grouping by a calculated value</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">byName</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">supergroup</span><span class="p">(</span><span class="nx">gradeBook</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">firstName</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">lastName</span><span class="p">;</span> <span class="p">});</span>
</span><span class='line'><span class="c1">// an Array of Strings:  [&quot;Sigfried Gold&quot;,&quot;Sigfried Sassoon&quot;,&quot;Sigfried Androy&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>It&#8217;s a native Array, but you can treat it as map, and then do cool stuff. Here&#8217;s a GPA:</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">byName</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s2">&quot;Sigfried Gold&quot;</span><span class="p">).</span><span class="nx">records</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">).</span><span class="nx">mean</span><span class="p">();</span> <span class="c1">//  2.6666666666666665 </span>
</span></code></pre></td></tr></table></div></figure>


<p>The above example shows how Supergroup can chain Underscore methods (and mixins), functionality
it gets from <a href="../underscore-unchained">underscore-unchained</a>.</p>

<figure class='code'><figcaption><span>Grouping hierarchically</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">byClassGrade</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">supergroup</span><span class="p">(</span><span class="nx">gradeBook</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;grade&quot;</span><span class="p">]);</span> <span class="c1">// Array of top-level groups: [&quot;Remedial Programming&quot;, &quot;Literary Posturing&quot;, &quot;Documenting with Pretty Colors&quot;]</span>
</span><span class='line'><span class="nx">byClassGrade</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">;</span> <span class="c1">// Children of a single group: [&quot;C&quot;, &quot;B&quot;]</span>
</span><span class='line'><span class="nx">byClassGrade</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">records</span><span class="p">;</span> <span class="c1">// Array original records for a single group</span>
</span><span class='line'><span class="nx">byClassGrade</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s2">&quot;Remedial Programming&quot;</span><span class="p">);</span> <span class="c1">// lookup a top-level group by name</span>
</span><span class='line'><span class="nx">byClassGrade</span><span class="p">.</span><span class="nx">lookup</span><span class="p">([</span><span class="s2">&quot;Remedial Programming&quot;</span><span class="p">,</span><span class="s2">&quot;B&quot;</span><span class="p">]);</span> <span class="c1">// lookup a second-level group by name path</span>
</span><span class='line'><span class="nx">byClassGrade</span><span class="p">.</span><span class="nx">lookup</span><span class="p">([</span><span class="s2">&quot;Remedial Programming&quot;</span><span class="p">,</span><span class="s2">&quot;B&quot;</span><span class="p">]).</span><span class="nx">namePath</span><span class="p">(</span><span class="s1">&#39; -&gt; &#39;</span><span class="p">);</span> <span class="c1">// &quot;Remedial Programming -&gt; B&quot;</span>
</span><span class='line'><span class="nx">byClassGrade</span><span class="p">.</span><span class="nx">lookup</span><span class="p">([</span><span class="s2">&quot;Remedial Programming&quot;</span><span class="p">,</span><span class="s2">&quot;B&quot;</span><span class="p">]).</span><span class="nx">dimPath</span><span class="p">()</span> <span class="c1">// &quot;class/grade&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Supergroup can flatten a tree into an array of nodes much like D3&rsquo;s hierarchy layout, but in a way
that&rsquo;s easier to use IMHO.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">byClassGrade</span><span class="p">.</span><span class="nx">flattenTree</span><span class="p">();</span> <span class="c1">// [&quot;Remedial Programming&quot;, &quot;C&quot;, &quot;A&quot;, &quot;B&quot;, &quot;Literary Posturing&quot;, &quot;B&quot;, &quot;Documenting with Pretty Colors&quot;, &quot;B&quot;]</span>
</span><span class='line'><span class="nx">byClassGrade</span><span class="p">.</span><span class="nx">flattenTree</span><span class="p">().</span><span class="nx">invoke</span><span class="p">(</span><span class="s1">&#39;namePath&#39;</span><span class="p">);</span> <span class="c1">// [&quot;Remedial Programming&quot;, &quot;Remedial Programming/C&quot;, &quot;Remedial Programming/A&quot;, &quot;Remedial Programming/B&quot;, &quot;Literary Posturing&quot;, &quot;Literary Posturing/B&quot;, &quot;Documenting with Pretty Colors&quot;, &quot;Documenting with Pretty Colors/B&quot;]</span>
</span><span class='line'><span class="c1">// only want leaf nodes?</span>
</span><span class='line'><span class="nx">byClassGrade</span><span class="p">.</span><span class="nx">leafNodes</span><span class="p">().</span><span class="nx">invoke</span><span class="p">(</span><span class="s1">&#39;namePath&#39;</span><span class="p">);</span> <span class="c1">// [&quot;Remedial Programming/C&quot;, &quot;Remedial Programming/A&quot;, &quot;Remedial Programming/B&quot;, &quot;Literary Posturing/B&quot;, &quot;Documenting with Pretty Colors/B&quot;]</span>
</span></code></pre></td></tr></table></div></figure>




<!--
<iframe style="width: 100%; height: 300px" frameborder="0" seamless="seamless" src="http://jsfiddle.net/us9k9/2/embedded/js,resources,html,css,result/light/"></iframe>
In a SQL group by query you get one record for each resulting group and
you can calculate values based on the aggregate of the rows comprised by
each group. Another step is needed to go back from the group to
the individual rows in that group. D3&#8217;s nest and Underscore&#8217;s groupBy do
slightly better in that they offer a collection of groups where each group
is tied to its associated records.


To explain the advantages of supergroup over Underscore and D3&#8217;s versions, let&#8217;s compare the results:

<figure class='code'><figcaption><span>Underscore&#8217;s groupBy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">_</span><span class="p">.</span><span class="nx">groupBy</span><span class="p">(</span><span class="nx">gradeBook</span><span class="p">,</span><span class="s1">&#39;lastName&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">Gold</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span> <span class="nx">firstName</span><span class="o">:</span> <span class="s2">&quot;Sigfried&quot;</span><span class="p">,</span> <span class="nx">lastName</span><span class="o">:</span> <span class="s2">&quot;Gold&quot;</span><span class="p">,</span> <span class="kr">class</span><span class="o">:</span> <span class="s2">&quot;Remedial Programming&quot;</span><span class="p">,</span> <span class="nx">grade</span><span class="o">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="nx">num</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span> <span class="nx">firstName</span><span class="o">:</span> <span class="s2">&quot;Sigfried&quot;</span><span class="p">,</span> <span class="nx">lastName</span><span class="o">:</span> <span class="s2">&quot;Gold&quot;</span><span class="p">,</span> <span class="kr">class</span><span class="o">:</span> <span class="s2">&quot;Literary Posturing&quot;</span><span class="p">,</span> <span class="nx">grade</span><span class="o">:</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="nx">num</span><span class="o">:</span> <span class="mi">3</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span> <span class="nx">firstName</span><span class="o">:</span> <span class="s2">&quot;Sigfried&quot;</span><span class="p">,</span> <span class="nx">lastName</span><span class="o">:</span> <span class="s2">&quot;Gold&quot;</span><span class="p">,</span> <span class="kr">class</span><span class="o">:</span> <span class="s2">&quot;Documenting with Pretty Colors&quot;</span><span class="p">,</span> <span class="nx">grade</span><span class="o">:</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="nx">num</span><span class="o">:</span> <span class="mi">3</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nx">Else</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span> <span class="nx">firstName</span><span class="o">:</span> <span class="s2">&quot;Someone&quot;</span><span class="p">,</span> <span class="nx">lastName</span><span class="o">:</span> <span class="s2">&quot;Else&quot;</span><span class="p">,</span> <span class="kr">class</span><span class="o">:</span> <span class="s2">&quot;Remedial Programming&quot;</span><span class="p">,</span> <span class="nx">grade</span><span class="o">:</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="nx">num</span><span class="o">:</span> <span class="mi">3</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<figure class='code'><figcaption><span>D3&#8217;s nest and map</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">d3</span><span class="p">.</span><span class="nx">nest</span><span class="p">().</span><span class="nx">key</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">lastName</span> <span class="p">}).</span><span class="nx">map</span><span class="p">(</span><span class="nx">gradeBook</span><span class="p">)</span> <span class="c1">// same result as Underscore.  </span>
</span></code></pre></td></tr></table></div></figure>

Because D3 visualizations depend so completely on arrays, D3 provides a way of structuring groups as arrays:

<figure class='code'><figcaption><span>D3&#8217;s nest and entries</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">d3</span><span class="p">.</span><span class="nx">nest</span><span class="p">().</span><span class="nx">key</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">lastName</span> <span class="p">}).</span><span class="nx">entries</span><span class="p">(</span><span class="nx">gradeBook</span><span class="p">)</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;Gold&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">values</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="p">{</span> <span class="nx">firstName</span><span class="o">:</span> <span class="s2">&quot;Sigfried&quot;</span><span class="p">,</span> <span class="nx">lastName</span><span class="o">:</span> <span class="s2">&quot;Gold&quot;</span><span class="p">,</span> <span class="kr">class</span><span class="o">:</span> <span class="s2">&quot;Remedial Programming&quot;</span><span class="p">,</span> <span class="nx">grade</span><span class="o">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="nx">num</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>            <span class="p">{</span> <span class="nx">firstName</span><span class="o">:</span> <span class="s2">&quot;Sigfried&quot;</span><span class="p">,</span> <span class="nx">lastName</span><span class="o">:</span> <span class="s2">&quot;Gold&quot;</span><span class="p">,</span> <span class="kr">class</span><span class="o">:</span> <span class="s2">&quot;Literary Posturing&quot;</span><span class="p">,</span> <span class="nx">grade</span><span class="o">:</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="nx">num</span><span class="o">:</span> <span class="mi">3</span> <span class="p">},</span>
</span><span class='line'>            <span class="p">{</span> <span class="nx">firstName</span><span class="o">:</span> <span class="s2">&quot;Sigfried&quot;</span><span class="p">,</span> <span class="nx">lastName</span><span class="o">:</span> <span class="s2">&quot;Gold&quot;</span><span class="p">,</span> <span class="kr">class</span><span class="o">:</span> <span class="s2">&quot;Documenting with Pretty Colors&quot;</span><span class="p">,</span> <span class="nx">grade</span><span class="o">:</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="nx">num</span><span class="o">:</span> <span class="mi">3</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;Else&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">values</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="p">{</span> <span class="nx">firstName</span><span class="o">:</span> <span class="s2">&quot;Someone&quot;</span><span class="p">,</span> <span class="nx">lastName</span><span class="o">:</span> <span class="s2">&quot;Else&quot;</span><span class="p">,</span> <span class="kr">class</span><span class="o">:</span> <span class="s2">&quot;Remedial Programming&quot;</span><span class="p">,</span> <span class="nx">grade</span><span class="o">:</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="nx">num</span><span class="o">:</span> <span class="mi">3</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// making a list with this data in D3 might look like this:</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gradeBookEntries</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">nest</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="nx">key</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">lastName</span> <span class="p">})</span>
</span><span class='line'>                    <span class="p">.</span><span class="nx">key</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">grade</span> <span class="p">})</span>
</span><span class='line'>                    <span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">gradeBook</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">_</span><span class="p">.</span><span class="nx">rebind</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="c1">// so console.log can be used as a callback</span>
</span><span class='line'>
</span><span class='line'><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;div#main&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;ul&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">gradeBookEntries</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">key</span> <span class="p">})</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;ul&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">values</span><span class="p">})</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="kr">class</span> <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="p">})</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gradeBookNames</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">supergroup</span><span class="p">(</span><span class="nx">gradeBook</span><span class="p">,[</span><span class="s1">&#39;lastName&#39;</span><span class="p">,</span><span class="s1">&#39;grade&#39;</span><span class="p">]);</span>
</span><span class='line'><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;div#main&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;ul&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">gradeBookNames</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">identity</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;ul&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">children</span><span class="p">})</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="p">})</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

These produce identical results with fairly similar syntax, but when the visualization
becomes more complex, the supergroup nodes are much more useful. A common use case
is providing information about a node on mouseover. 

One drawback of d3.nest above is a difference in datum types between parent and leaf
nodes: datum.values at a parent node is an array of {key:&#8217;&#8230;&#8217;,values:[&#8230;]}, but at
the leaf node it&#8217;s an array of raw records.

Supergroup does not mix up raw records and hierarchy children in this way. At every
level &#8216;records&#8217; refers to raw records (which you can only access as leaf nodes in
d3.nest) and &#8216;children&#8217; refers to nested children if there are any at that node.





gradeBookNames = _.supergroup(gradeBook,[&#8216;lastName&#8217;,&#8217;grade&#8217;]);
 d3.select(&#8216;div#main&#8217;).append(&#8216;ul&#8217;).selectAll(&#8216;li&#8217;)
    .data(gradeBookEntries)
    .enter()
    .append(&#8216;li&#8217;)
        .text(_.identity)
    .append(&#8216;ul&#8217;).selectAll(&#8216;li&#8217;)
        .data(function(d) { return d.records})
        .enter()
        .append(&#8216;li&#8217;)
            .text(function(d) { return d.namePath() })


d3.select(&#8216;body&#8217;).append(&#8216;ul&#8217;).selectAll(&#8216;li&#8217;)
    .data(gradeBookEntries)
    .enter()
    .append(&#8216;li&#8217;)
        .text(function(d) { return d.key })
    .append(&#8216;p&#8217;)
        .text(function(d) { return d.values.length + &#8217; records in group &#8217; + this.parentNode.__data__.key })
<figure class='code'><figcaption><span>D3&#8217;s nest and entries</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">has</span> <span class="nx">the</span> <span class="nx">exact</span> <span class="nx">same</span> <span class="nx">result</span> <span class="p">(</span><span class="kd">with</span> <span class="nx">less</span> <span class="nx">pleasant</span> <span class="nx">syn</span>
</span></code></pre></td></tr></table></div></figure> javascript
var gradeBook = [
   {firstName: &#8216;Sigfried&#8217;, lastName: &#8216;Gold&#8217;, class: &#8216;Remedial Programming&#8217;, grade: &#8216;C+&#8217;, num: 2.2},
   {firstName: &#8216;Sigfried&#8217;, lastName: &#8216;Gold&#8217;, class: &#8216;Literary Posturing&#8217;, grade: &#8216;B&#8217;, num: 3},
   {firstName: &#8216;Sigfried&#8217;, lastName: &#8216;Gold&#8217;, class: &#8216;Documenting with Pretty Colors&#8217;, grade: &#8216;B-&#8216;, num: 2.7},
   {firstName: &#8216;Someone&#8217;, lastName: &#8216;Else&#8217;, class: &#8216;Remedial Programming&#8217;, grade: &#8216;A&#8217;}];

var gradesByLastName = enlightenedData.group(gradeBook, &#8216;lastName&#8217;)
<figure class='code'><figcaption><span>D3&#8217;s nest and entries</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>
</span></code></pre></td></tr></table></div></figure> javascript
var gradesByName = enlightenedData.group(gradeBook,  
        function(d) { return d.lastName + &#8216;, &#8217; + d.firstName },  
        {dimName: &#8216;fullName&#8217;})

var sigfried = gradesByName.lookup(&#8216;Gold, Sigfried&#8217;);
sigfried.records.length; // 3
var sigfriedGPA = sigfried.records.reduce(function(result,rec) { return result+rec.num }, 0) / sigfried.records.length;
(it does much much more, will explain below)
&#8220;`
File /Users/sigfried/Sites/git_projects/sigfried.github.io/source/downloads/code/supergroup-test.js could not be found
&#8211;>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[TreeLike CSV Data Browser]]></title>
    <link href="http://Sigfried.github.io/blog/treelike/"/>
    <updated>2013-12-27T00:06:00-05:00</updated>
    <id>http://Sigfried.github.io/blog/treelike</id>
    <content type="html"><![CDATA[<p>TreeLike is an experimental tool allowing rapid exploration
of the contents and inter-relationships across the columns of spreadsheet or
CSV data. Use it to load any local CSV file.
It immediately shows the distributions of values in all columns, and by
laying out the columns in some nesting order, can show hierarchical
relationships between values across columns. When two columns have a
many-to-many relationship, the merge feature shows connections in both
directions, not just from parent to child. And parent/child
relationships can be reordered with one or two mouse clicks.</p>

<!-- more -->


<p><a href="../treelike/demo.html">Demo</a> (you&rsquo;ll need a data file, how about: <a href="https://raw.github.com/Sigfried/treelike/master/data/mysql_world_data.csv">MySQL world data</a>)</p>

<p>To understand what it does, you need to see it in action. This rough
demo video will explain:</p>

<iframe width="420" height="315" src="http://Sigfried.github.io//www.youtube.com/embed/mJ8ljG8qpZk" frameborder="0" allowfullscreen></iframe>


<p>TreeLike will be most helpful with files of between about 4 and
20 columns. It should be fine with at least tens of thousands of rows,
but it hasn&rsquo;t been well tested.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sequence-viz]]></title>
    <link href="http://Sigfried.github.io/blog/sequence-viz/"/>
    <updated>2013-12-27T00:04:00-05:00</updated>
    <id>http://Sigfried.github.io/blog/sequence-viz</id>
    <content type="html"><![CDATA[<p>A collection of visualization tools for exploring sequences of events
over time. Offers the first open-source, Javascript implementation of
Krist Wongsuphasawat&rsquo;s <a href="http://www.cs.umd.edu/hcil/lifeflow/">LifeFlow</a>
for temporal summary visualization as well as extensions and related
techniques.</p>

<!-- more -->


<p>After cloning, remember to run</p>

<pre><code>git submodule init
git submodule update
</code></pre>

<p><a href="http://sigfried.org/lifeflow/lifeflowWithStuff.html">LifeFlow demo</a></p>

<p><a href="http://sigfried.org/lifeflow/hurricaneLifeflowUnadorned.html">LifeFlow stripped down demo</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Merki]]></title>
    <link href="http://Sigfried.github.io/blog/merki/"/>
    <updated>2013-12-27T00:03:00-05:00</updated>
    <id>http://Sigfried.github.io/blog/merki</id>
    <content type="html"><![CDATA[<p><strong>Medication Extraction and Reconciliation Knowledge Instrument.</strong>
A tool for extracting structured medication information from discharge
summaries and other free-text narrative sources, described in this
<a href="http://www.amia.org/amia-awards/annual-conference-awards">award-winning</a>
paper: <a href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC2655993/">Extracting Structured Medication Event Information from Discharge Summaries</a> by
Sigfried Gold, Nomie Elhadad, Xinxin Zhu, James J. Cimino, and George Hripcsak.</p>

<!-- more -->


<p><a href="http://scholar.google.com/scholar?cites=12861617034331125757&amp;as_sdt=20000005&amp;sciodt=0,21&amp;hl=en">Citations</a>
where you may find more effective parsers built more recently. If you
learn of any that are also open source, let me know!</p>

<h3>MERKI Parser, Public Version, Documentation</h3>

<p>Files:</p>

<pre><code>ParseMeds.pm            parser code module
drugParseRules.yaml     parser rules.  can be edited if you understand regular expressions.
druglist.tsv            list of drug names, CUIs and TTY for ingredients and brand names from RxNorm
gpl.txt                 GPL3 license text
parseFromPerl.pl        example of how to call the parser from a Perl script
parseFromShell.pl       command line version.  run like:
                            echo "...tylenol 250mg po daily..." | perl parseFromShell.pl
</code></pre>

<p>MERKI was a sprawling, ambitious application I worked on during my time
as a student of Biomedical Informatics at Columbia University.  It&rsquo;s
purpose was to extract medication information from structured and
free-text patient data, standardize and condense it, and produce a
complete and concise listing of all medications mentioned in each
patient&rsquo;s electronic medical record.  The larger project was never
finished.  The current files are a portable subset that allow the
parsing of narrative clinical text for the extraction of structured
medication information.</p>

<p>The following two lines from parseFromShell.pl show how to use the
parser:</p>

<pre><code>my $drugs = $parser-&gt;twoLevelParse($input, 
    ['drug', 'possibleDrug', 'context'], 
    ['dose', 'route', 'freq', 'prn', 'date']);  
print $parser-&gt;drugsToXML($drugs);
</code></pre>

<p>$parser->twoLevelParser goes over its input twice: once to extract
drugs, possible drugs, and contexts; and a second time to find, within
each drug or possible drug, the dose, route, frequence, prn and dates.
twoLevelParser returns a Perl data structure which can then be passed
to $parser->drugsToXML or $parser->drugsToHTMLTable in order to turn
it into something more directly usable.  Here is an example (taken from
bits of random clinical text, and not meant to be clinically plausible):</p>

<pre><code>unixshell$ echo "Discharge medications: Procardia XL 60 mg p.o. prn for severe wheezing, ferros sulfate 300 mg p.o. b.i.d., Cipro 250 mg p.o. q12hQ" | perl parseFromShell.pl
&lt;drugs&gt;
    &lt;drug&gt;
        &lt;drugName&gt;Procardia XL&lt;/drugName&gt;
        &lt;dose&gt;60 mg&lt;/dose&gt;
        &lt;route&gt;p.o.&lt;/route&gt;
        &lt;prn&gt;prn for severe wheezing&lt;/prn&gt;
        &lt;startChar&gt;23&lt;/startChar&gt;
        &lt;endChar&gt;69&lt;/endChar&gt;
        &lt;textLength&gt;47&lt;/textLength&gt;
        &lt;when&gt;after discharge&lt;/when&gt;
        &lt;context&gt;Discharge meds&lt;/context&gt;
        &lt;surroundingText&gt;discharge medications: [Procardia XL 60 mg p.o. prn for severe wheezing], ferros sulfate 300 mg p.o. b&lt;/surroundingText&gt;
    &lt;/drug&gt;
    &lt;possibleDrug&gt;
        &lt;drugName&gt;ferros sulfate &lt;/drugName&gt;
        &lt;dose&gt;300 mg&lt;/dose&gt;
        &lt;route&gt;p.o.&lt;/route&gt;
        &lt;freq&gt;b.i.d.&lt;/freq&gt;
        &lt;startChar&gt;72&lt;/startChar&gt;
        &lt;endChar&gt;104&lt;/endChar&gt;
        &lt;textLength&gt;33&lt;/textLength&gt;
        &lt;when&gt;after discharge&lt;/when&gt;
        &lt;context&gt;Discharge meds&lt;/context&gt;
        &lt;surroundingText&gt;p.o. prn for severe wheezing, [ferros sulfate 300 mg p.o. b.i.d.], D1DDD 250 mg p.o. q12hq&lt;/surroundingText&gt;
    &lt;/possibleDrug&gt;
    &lt;drug&gt;
        &lt;drugName&gt;Cipro&lt;/drugName&gt;
        &lt;dose&gt;250 mg&lt;/dose&gt;
        &lt;route&gt;p.o.&lt;/route&gt;
        &lt;freq&gt;q12&lt;/freq&gt;
        &lt;startChar&gt;107&lt;/startChar&gt;
        &lt;endChar&gt;127&lt;/endChar&gt;
        &lt;textLength&gt;21&lt;/textLength&gt;
        &lt;when&gt;after discharge&lt;/when&gt;
        &lt;context&gt;Discharge meds&lt;/context&gt;
        &lt;surroundingText&gt;s sulfate 300 mg p.o. b.i.d., [Cipro 250 mg p.o. q12]hq&lt;/surroundingText&gt;
    &lt;/drug&gt;
&lt;/drugs&gt;
</code></pre>

<p>To understand how the parser decides what counts as a drug, a possible
drug, a context, a dose, route, etc., look at these tokens in
drugParseRules.yaml.  The parser itself (ParseMeds.pm) treats context
tokens differently than drugs and possible drugs.  Any context token
found becomes  the context attribute of all drugs and possible drugs
following it, until another context is found.</p>

<p>Notice that &ldquo;ferros sulfate&rdquo; (&ldquo;ferrous sulfate&rdquo; misspelled) appears as
a possible drug rather than as a drug.  Since it is misspelled, it is
not found in the drug lexicon, but it is still identified as a possible
drug because it appears before a dose, route, and frequency.  (Look at
the definition of possibleDrug in drugParseRules.yaml.)</p>

<p>This application is far from perfect, and if you do find it worth using,
there is a good chance you will want to modify it for your own uses.</p>

<p>Changing the drug lexicon should be fairly straightforward.  You can
add, delete, or change entries as you like, or use an entirely different
lexicon.  If you change the format of the lexicon, you may need to
change aspects of the parser that load and look up drugs.</p>

<p>You may want to change the parsing rules to catch drug phrases that the
current set of rules won&rsquo;t catch, or, alternatively, to make the rules
more conservative to prevent false positives.  You&rsquo;ll need to understand
the basics of the YAML format (or just follow the example of the current
drugParseRules.yaml file), and, more importantly, you&rsquo;ll need to
understand Perl regular expressions and the special way that the parsing
rules are processed.  I&rsquo;ll explain how the parsing rules are processed
now.</p>

<p>Tokens are divided into terminals and non-terminals.  Tokens of either
sort are transformed by the parser into single Perl regular expressions.
The difference is that non-terminals can include terminals and other
non-terminals in their definition.  You&rsquo;ll also notice that the way they
are written is slightly different, but that is just to make them more
readable.  Also, terminals can include literal text, but non-terminals
cannot (because they try to interpret literal text as a reference to
another token.)</p>

<p>Terminals are made up of a name followed by a list of expressions or
pieces of literal text.  Take, for instance, the terminal cond:</p>

<pre><code>cond:   [ud, ut dict, prm-breakthrough, '(were|was) held', discontinued, "dc'd"]
</code></pre>

<p>This will be converted into the (approximately) following regular expression:</p>

<pre><code>/(ud|ut dict|prn-breakthrough|(were|was) held|discontinued|dc\'d)/
</code></pre>

<p>Actually, two other options will be added to the list of strings it will
match: &ldquo;u.d.&rdquo; and &ldquo;ut dict.&rdquo;  This is because the convenience rule
dotsAfterLtrOk includes &ldquo;ud&rdquo; and the convenience rule dotsAtEndOk
includes &ldquo;ut dict&rdquo;.</p>

<p>The terminal cond is used in the non-terminal prn:</p>

<pre><code>- name: prn
  patterns:
    - 'asNeeded\s*qualifier'
    - '(cond|asNeeded)'
</code></pre>

<p>This translates into &ldquo;prn&rdquo; or &ldquo;as needed&rdquo; (that&rsquo;s how &ldquo;asNeeded&rdquo; is
defined) followed by a qualifier (something like &ldquo;for severe pain&rdquo;), OR
something that matches the cond token, OR something that matches the
asNeeded token.  Generally you will see the parsing rules composed
such that more specific, longer expressions appear before less specific,
shorter expressions.  This is because the first expression matched will
be kept and subsequent expressions will not be tried.</p>

<p>Finally, you may also want to modify the parsing code itself, but that
code is not documented and may be hard to understand.</p>

<p>If you do make changes, or even if you use the code at all, I would very
much appreciate hearing from you.  I may be able to offer assistance,
and I may be able to make your improvements available to others.</p>

<p>Contact <a href="http://sigfried.org">Sigfried Gold</a> with questions.</p>
]]></content>
  </entry>
  
</feed>
